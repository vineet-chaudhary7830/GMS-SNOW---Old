<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller = function($scope, $timeout) {
    var c = this;

    c.checkInTime = '--:--:--';
    c.checkOutTime = '--:--:--';
    c.photoDataUrl = null;
    c.cameraReady = false;
    c.showMessage = false;
    c.messageText = '';
    c.messageType = '';
    c.stream = null;

    c.showMessageBox = function(message, type) {
        c.messageText = message;
        c.messageType = type;
        c.showMessage = true;
        
        $timeout(function() {
            c.showMessage = false;
        }, 3000);
    };

    c.checkIn = function() {
        var now = new Date();
        c.checkInTime = now.toLocaleTimeString();
        c.showMessageBox('Check-in time recorded!', 'success');
    };

    c.checkOut = function() {
        var now = new Date();
        c.checkOutTime = now.toLocaleTimeString();
        c.showMessageBox('Check-out time recorded!', 'success');
    };

    c.openCamera = function() {
  if (typeof navigator.mediaDevices === 'undefined' || typeof navigator.mediaDevices.getUserMedia === 'undefined') {
    c.showMessageBox('Error: This browser does not support the camera API.', 'error');
    return;
  }

  navigator.mediaDevices.getUserMedia({ video: true, audio: false })
    .then(function(s) {
      c.stream = s;

      // Delay DOM access to ensure video element is rendered
      $timeout(function() {
        var video = document.getElementById('videoElement');
        if (video) {
          video.srcObject = c.stream;
          video.play(); // Ensure playback starts
          c.cameraReady = true;
          c.showMessageBox('Camera is ready!', 'success');
        } else {
          c.showMessageBox('Video element not found.', 'error');
        }
      }, 500); // Delay to ensure DOM is ready
    })
    .catch(function(err) {
      console.error('Camera error:', err);
      c.showMessageBox('Could not access the camera. Please check permissions.', 'error');
    });
};

c.takePicture = function() {
  if (!c.stream) {
    c.showMessageBox('Please open the camera first.', 'error');
    return;
  }

  $timeout(function() {
    var video = document.getElementById('videoElement');
    var canvas = document.getElementById('photoCanvas');

    if (video && canvas) {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      var ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      c.photoDataUrl = canvas.toDataURL('image/png');

      // Stop camera stream
      c.stream.getTracks().forEach(function(track) {
        track.stop();
      });

      video.srcObject = null;
      c.cameraReady = false;
			
 c.server.update({
        action: 'save_photo',
        photoDataUrl: c.photoDataUrl,
        recordSysId: c.data.recordSysId // Pass the record ID
      });

      c.showMessageBox('Picture taken successfully!', 'success');
    } else {
      c.showMessageBox('Camera or canvas element not found.', 'error');
    }
  }, 500); // Delay to ensure video frame is ready
};
  c.submit = function() {
  var payload = {
    checkIn: c.checkInTime !== '--:--:--' ? c.checkInTime : null,
    checkOut: c.checkOutTime !== '--:--:--' ? c.checkOutTime : null,
    photo: c.photoDataUrl || null
  };

  c.server.get({
    action: 'saveCheckinData',
    payload: payload
  }).then(function(response) {
    if (response.status === 'inserted') {
      c.showMessageBox('Check-in data saved!', 'success');
    } else if (response.status === 'updated') {
      c.showMessageBox('Check-out data updated!', 'success');
    } else {
      c.showMessageBox('Unexpected response from server.', 'error');
    }
  });
};
};
]]></client_script>
        <controller_as>c</controller_as>
        <css>body {
    font-family: 'Inter', sans-serif;
    background-color: #f3f4f6;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 1rem;
}

/* Utility for messages */
.message-box {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    padding: 1rem 2rem;
    border-radius: 0.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    color: white;
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
    text-align: center;
}
.message-box.show {
    opacity: 1;
}

/* Main Form Container */
.form-container {
    width: 100%;
    max-width: 48rem; /* Equivalent to max-w-2xl */
    background-color: #ffffff;
    border-radius: 0.75rem; /* Equivalent to rounded-xl */
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* Equivalent to shadow-2xl */
    padding: 2.5rem; /* Equivalent to p-10 */
    border: 1px solid #e5e7eb;
}
@media (max-width: 768px) {
    .form-container {
        padding: 1.5rem; /* Equivalent to p-6 */
    }
}

/* Section Styling */
.form-section {
    margin-bottom: 2rem;
    padding: 1.5rem;
    border-radius: 0.5rem;
    border-width: 1px;
}
.checkin-section { background-color: #eff6ff; border-color: #bfdbfe; } /* bg-blue-50, border-blue-200 */
.camera-section { background-color: #faf5ff; border-color: #e9d5ff; } /* bg-purple-50, border-purple-200 */
.checkout-section { background-color: #ecfdf5; border-color: #a7f3d0; } /* bg-emerald-50, border-emerald-200 */
.text-center { text-align: center; }

/* Headings */
.main-heading {
    font-size: 1.875rem; /* text-3xl */
    font-weight: 700; /* font-bold */
    color: #1f2937; /* text-gray-800 */
    text-align: center;
    margin-bottom: 1.5rem;
}
.section-heading {
    font-size: 1.25rem; /* text-xl */
    font-weight: 600; /* font-semibold */
    color: #374151; /* text-gray-700 */
    margin-bottom: 1rem;
}

/* Flexbox utilities */
.flex-row-center {
    display: flex;
    align-items: center;
    gap: 1rem;
}
.flex-col-md-row {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
}
@media (min-width: 768px) {
    .flex-col-md-row {
        flex-direction: row;
    }
}
.camera-controls {
    margin-top: 1rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 1rem;
}
@media (min-width: 640px) {
    .camera-controls {
        flex-direction: row;
    }
}

/* Video/Image Containers */
.video-container, .photo-preview-container {
    width: 100%;
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    border: 1px solid #d1d5db;
}
@media (min-width: 768px) {
    .video-container, .photo-preview-container {
        width: 50%;
    }
}

/* Buttons */
.button {
    color: #ffffff;
    font-weight: 600;
    padding: 0.5rem 1.5rem;
    border-radius: 0.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease-in-out;
    transform: scale(1);
}
.button:hover {
    transform: scale(1.05);
}
.checkin-button { background-color: #2563eb; }
.checkin-button:hover { background-color: #1d4ed8; }
.checkout-button { background-color: #10b981; }
.checkout-button:hover { background-color: #059669; }
.camera-button { background-color: #9333ea; }
.camera-button:hover { background-color: #7e22ce; }
.submit-button { 
    background-color: #1f2937; 
    font-weight: 700; 
    padding: 0.75rem 3rem; 
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
}
.submit-button:hover { background-color: #374151; }

/* Other elements */
.time-display {
    color: #4b5563;
    font-size: 1.125rem; /* text-lg */
    font-weight: 500; /* font-medium */
}
</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id/>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>GMS Homepage Widget</name>
        <option_schema/>
        <public>true</public>
        <roles/>
        <script><![CDATA[(function() {
  try {
    if (input && input.action === 'saveCheckinData') {
      var payload = input.payload;
      var userId = gs.getUserID();

      var gr = new GlideRecord('x_1606613_gym_ma_0_gym_attend');
      if (!gr.isValid()) {
        return { status: 'error', message: 'Invalid table name' };
      }

      gr.initialize();
      gr.gym_member = userId;
      gr.check_in_time = payload.checkIn;
      gr.insert();

      if (payload.photo) {
        var base64Data = payload.photo.split(',')[1];
        var contentType = 'image/png';
        var fileName = 'checkin_photo_' + gr.getUniqueValue() + '.png';

        var helper = new GMS_AttachmentHelper();
        helper.saveBase64Image('x_1606613_gym_ma_0_gym_attend', gr.getUniqueValue(), fileName, contentType, base64Data);
      }

      return { status: 'inserted', recordSysId: gr.getUniqueValue() };
    } else {
      return { status: 'error', message: 'Invalid input or action' };
    }
  } catch (e) {
    gs.error('Exception in saveCheckinData: ' + e.message);
    return { status: 'error', message: 'Exception: ' + e.message };
  }
})();
]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-08-30 19:56:38</sys_created_on>
        <sys_id>3b5be57383272210ed9bfe55eeaad3fe</sys_id>
        <sys_mod_count>30</sys_mod_count>
        <sys_name>GMS Homepage Widget</sys_name>
        <sys_package display_value="GYM Management Application" source="x_1606613_gym_ma_0">e737c57383632210ed9bfe55eeaad3ee</sys_package>
        <sys_policy/>
        <sys_scope display_value="GYM Management Application">e737c57383632210ed9bfe55eeaad3ee</sys_scope>
        <sys_update_name>sp_widget_3b5be57383272210ed9bfe55eeaad3fe</sys_update_name>
        <sys_updated_by>s.parashar</sys_updated_by>
        <sys_updated_on>2025-09-01 12:29:59</sys_updated_on>
        <template><![CDATA[<div class="form-container">
    <h1 class="main-heading">Real-Time Check-in System</h1>
    
    <!-- Check-in Section -->
    <div class="form-section checkin-section">
        <h2 class="section-heading">Check-in Time</h2>
        <div class="flex-row-center">
            <button ng-click="c.checkIn()" class="button checkin-button">Check In</button>
            <div id="checkInTime" class="time-display">{{c.checkInTime}}</div>
        </div>
    </div>

    <!-- Camera Section -->
    <div class="form-section camera-section">
        <h2 class="section-heading">Take a Picture</h2>
        <div class="flex-col-md-row">
            <!-- Video Stream -->
            <div class="video-container">
                <video id="videoElement" width="100%" autoplay></video>
            </div>
            <!-- Captured Photo -->
            <div class="photo-preview-container">
                <img id="photoPreview" width="100%" ng-src="{{c.photoDataUrl || '[https://placehold.co/600x400/e2e8f0/64748b?text=Captured+Photo](https://placehold.co/600x400/e2e8f0/64748b?text=Captured+Photo)'}}" alt="Captured Photo">
                <canvas id="photoCanvas" style="display:none;"></canvas>
            </div>
        </div>
        <div class="camera-controls">
            <button ng-click="c.openCamera()" class="button camera-button">Open Camera</button>
            <button ng-click="c.takePicture()" class="button camera-button" ng-disabled="!c.cameraReady">Take Picture</button>
        </div>
    </div>

    <!-- Check-out Section -->
    <div class="form-section checkout-section">
        <h2 class="section-heading">Check-out Time</h2>
        <div class="flex-row-center">
            <button ng-click="c.checkOut()" class="button checkout-button">Check Out</button>
            <div id="checkOutTime" class="time-display">{{c.checkOutTime}}</div>
        </div>
    </div>

    <!-- Final Submission Button -->
    <div class="text-center">
        <button ng-click="c.submit()" class="button submit-button">Final Submission</button>
    </div>

</div>

<!-- Message Box -->
<div id="messageBox" class="message-box" ng-class="{'show': c.showMessage}" ng-style="{ 'background-color': c.messageType === 'success' ? '#10b981' : (c.messageType === 'error' ? '#ef4444' : '#3b82f6') }">
    {{c.messageText}}
</div>
]]></template>
    </sp_widget>
</record_update>
